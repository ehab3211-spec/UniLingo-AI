<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UniLingo-AI Visual Workflow Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; overflow: hidden; }
    #sidebar { position: absolute; left: 0; top: 0; width: 200px; height: 100vh; background: #f4f4f4; padding: 10px; box-sizing: border-box; }
    #canvas { position: absolute; left: 200px; top: 0; right: 0; bottom: 0; background: #fff; overflow: hidden; }
    .node { padding: 10px; border: 2px solid #1a73e8; border-radius: 5px; background: #e8f0fe; position: absolute; cursor: move; user-select: none; }
    button { width: 100%; margin: 5px 0; padding: 8px; background: #1a73e8; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #1558b0; }
    input { width: 100%; margin: 5px 0; padding: 5px; }
    svg { position: absolute; top: 0; left: 0; pointer-events: none; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>Nodes</h3>
  <button onclick="addNode('generate_text')">Text</button>
  <button onclick="addNode('generate_image')">Image</button>
  <button onclick="addNode('generate_audio')">Audio</button>
  <button onclick="addNode('merge_video')">Merge Video</button>
  <button onclick="addNode('conditional')">Conditional</button>
  <hr>
  <h3>Pi Payment</h3>
  <input id="userId" placeholder="User ID">
  <input id="txId" placeholder="Pi Tx ID">
  <input id="piAmount" type="number" placeholder="Pi Amount">
  <button onclick="runWorkflow()">Run Workflow</button>
</div>

<div id="canvas"></div>
<svg id="connections"></svg>

<script>
let nodeId = 0;
const nodes = [];
const edges = [];
const canvas = document.getElementById('canvas');
const svg = document.getElementById('connections');

function addNode(type) {
  const node = document.createElement('div');
  node.className = 'node';
  node.id = 'node' + nodeId++;
  node.innerText = type;
  node.style.left = '50px';
  node.style.top = (50 + nodes.length * 80) + 'px';
  node.dataset.type = type;
  node.dataset.id = node.id;

  node.draggable = true;
  node.ondragstart = (e) => {
    e.dataTransfer.setData('text/plain', node.id);
  };

  node.onclick = () => {
    if (selectedNode && selectedNode !== node) {
      edges.push({ from: selectedNode.id, to: node.id });
      drawEdges();
      selectedNode = null;
    } else {
      selectedNode = node;
    }
  }

  canvas.appendChild(node);
  nodes.push(node);
  drawEdges();
}

let selectedNode = null;

function drawEdges() {
  svg.innerHTML = '';
  edges.forEach(edge => {
    const fromNode = document.getElementById(edge.from);
    const toNode = document.getElementById(edge.to);
    const fromRect = fromNode.getBoundingClientRect();
    const toRect = toNode.getBoundingClientRect();

    const x1 = fromRect.left + fromRect.width / 2 - canvas.getBoundingClientRect().left;
    const y1 = fromRect.top + fromRect.height / 2 - canvas.getBoundingClientRect().top;
    const x2 = toRect.left + toRect.width / 2 - canvas.getBoundingClientRect().left;
    const y2 = toRect.top + toRect.height / 2 - canvas.getBoundingClientRect().top;

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#1a73e8');
    line.setAttribute('stroke-width', 2);
    svg.appendChild(line);
  });
}

function runWorkflow() {
  const userId = document.getElementById('userId').value;
  const txId = document.getElementById('txId').value;
  const piAmount = parseFloat(document.getElementById('piAmount').value);

  const workflow = nodes.map(n => ({ action: n.dataset.type }));

  fetch('http://localhost:3000/command', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, txId, requiredPi: piAmount, command: workflow })
  })
  .then(res => res.json())
  .then(data => alert(JSON.stringify(data, null, 2)))
  .catch(err => alert(err.message));
}
</script>

</body>
</html>
